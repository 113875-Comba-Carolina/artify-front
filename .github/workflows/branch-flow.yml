name: Branch Flow Management

on:
  pull_request:
    types: [opened, closed, merged]
  push:
    branches: [ develop, master ]

jobs:
  validate-branch-flow:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Validate branch flow
      run: |
        echo "ðŸ” Validating branch flow..."
        
        # Obtener informaciÃ³n del evento
        if [ "${{ github.event_name }}" = "pull_request" ]; then
          echo "ðŸ“‹ PR Event: ${{ github.event.action }}"
          echo "ðŸ“‹ Source Branch: ${{ github.head_ref }}"
          echo "ðŸ“‹ Target Branch: ${{ github.base_ref }}"
          
          # Validar que las PRs vayan a develop o master
          if [ "${{ github.base_ref }}" != "develop" ] && [ "${{ github.base_ref }}" != "master" ]; then
            echo "âŒ Error: PRs must target 'develop' or 'master' branches"
            exit 1
          fi
          
          # Validar que las features vayan a develop
          if [[ "${{ github.head_ref }}" == feature/* ]] && [ "${{ github.base_ref }}" != "develop" ]; then
            echo "âŒ Error: Feature branches must target 'develop'"
            exit 1
          fi
          
          # Validar que los hotfixes vayan a master
          if [[ "${{ github.head_ref }}" == hotfix/* ]] && [ "${{ github.base_ref }}" != "master" ]; then
            echo "âŒ Error: Hotfix branches must target 'master'"
            exit 1
          fi
          
          echo "âœ… Branch flow validation passed"
        fi
        
        if [ "${{ github.event_name }}" = "push" ]; then
          echo "ðŸ“‹ Push Event to: ${{ github.ref_name }}"
          
          # Validar que master solo reciba merges de develop
          if [ "${{ github.ref_name }}" = "master" ]; then
            echo "ðŸ” Checking if master is being updated from develop..."
            # Esta validaciÃ³n se puede mejorar con mÃ¡s lÃ³gica de Git
            echo "âœ… Master branch updated"
          fi
          
          if [ "${{ github.ref_name }}" = "develop" ]; then
            echo "ðŸ” Checking if develop is being updated from feature branches..."
            echo "âœ… Develop branch updated"
          fi
        fi
        
    - name: Create deployment summary
      if: github.event_name == 'pull_request' && github.event.action == 'closed'
      run: |
        echo "ðŸ“Š Creating deployment summary..."
        echo "## ðŸš€ Deployment Summary" >> $GITHUB_STEP_SUMMARY
        echo "- **Branch**: ${{ github.head_ref }} â†’ ${{ github.base_ref }}" >> $GITHUB_STEP_SUMMARY
        echo "- **Status**: ${{ github.event.pull_request.merged }}" >> $GITHUB_STEP_SUMMARY
        echo "- **Commit**: ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
        echo "- **Author**: ${{ github.actor }}" >> $GITHUB_STEP_SUMMARY
        
        if [ "${{ github.event.pull_request.merged }}" = "true" ]; then
          echo "âœ… **Ready for deployment**" >> $GITHUB_STEP_SUMMARY
        else
          echo "âŒ **PR was closed without merging**" >> $GITHUB_STEP_SUMMARY
        fi
