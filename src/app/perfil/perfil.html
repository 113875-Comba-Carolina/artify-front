<!-- Header -->
<div class="perfil-header">
  <div class="container">
    <div class="header-content">
      <button (click)="volver()" class="back-button">
        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path>
        </svg>
        Volver
      </button>
      <h1 class="perfil-title">Mi Perfil</h1>
    </div>
  </div>
</div>

<!-- Perfil Content -->
<div class="perfil-container">
  <div class="container">
    @if (isLoading) {
      <div class="loading-container">
        <div class="loading-spinner"></div>
        <p class="loading-text">Cargando perfil...</p>
      </div>
    } @else if (perfil) {
      <div class="perfil-content">
        <!-- Información del perfil -->
        <div class="perfil-card">
          <div class="perfil-header-card">
            <div class="avatar">
              <svg class="w-16 h-16" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"></path>
              </svg>
            </div>
            <div class="perfil-info">
              <h2 class="perfil-nombre">{{ perfil.nombre }}</h2>
              <p class="perfil-email">{{ perfil.email }}</p>
              <p class="perfil-telefono" *ngIf="perfil.telefono">
                <svg class="w-4 h-4 inline mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 5a2 2 0 012-2h3.28a1 1 0 01.948.684l1.498 4.493a1 1 0 01-.502 1.21l-2.257 1.13a11.042 11.042 0 005.516 5.516l1.13-2.257a1 1 0 011.21-.502l4.493 1.498a1 1 0 01.684.949V19a2 2 0 01-2 2h-1C9.716 21 3 14.284 3 6V5z"></path>
                </svg>
                {{ perfil.telefono }}
              </p>
              <div class="perfil-rol">
                <span class="rol-badge" [class.artesano]="esArtesano()">
                  {{ esArtesano() ? 'Artesano' : 'Usuario' }}
                </span>
              </div>
            </div>
            <div class="perfil-actions">
              <button (click)="iniciarEdicionPerfil()" class="edit-button" [disabled]="editandoPerfil">
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"></path>
                </svg>
                Editar Perfil
              </button>
            </div>
          </div>

          <!-- Información específica del artesano -->
          @if (esArtesano()) {
            <div class="artesano-info">
              <h3 class="section-title">Información del Emprendimiento</h3>
              <div class="info-grid">
                <div class="info-item">
                  <label class="info-label">Nombre del Emprendimiento</label>
                  <p class="info-value">{{ getArtesanoInfo().nombreEmprendimiento }}</p>
                </div>
                <div class="info-item">
                  <label class="info-label">Descripción</label>
                  <p class="info-value">{{ getArtesanoInfo().descripcion }}</p>
                </div>
                <div class="info-item">
                  <label class="info-label">Ubicación</label>
                  <p class="info-value">{{ getArtesanoInfo().ubicacion }}</p>
                </div>
              </div>
              <div class="artesano-actions">
                <button (click)="irAGestionProductos()" class="manage-products-button">
                  <svg class="w-4 h-4 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20 7l-8-4-8 4m16 0l-8 4m8-4v10l-8 4m0-10L4 7m8 4v10M4 7v10l8 4"></path>
                  </svg>
                  Gestionar Productos
                </button>
              </div>
            </div>
          }

          <!-- Opción para convertirse en artesano -->
          @if (puedeConvertirseArtesano()) {
            <div class="convertir-artesano-section">
              <h3 class="section-title">¿Quieres vender tus productos?</h3>
              <p class="section-description">
                Conviértete en artesano y comienza a vender tus creaciones en Artify.
              </p>
              <button (click)="iniciarConversionArtesano()" class="convert-button">
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"></path>
                </svg>
                Convertirse en Artesano
              </button>
            </div>
          }
        </div>

        <!-- Formulario de edición de perfil -->
        @if (editandoPerfil) {
          <div class="form-card">
            <h3 class="form-title">Editar Perfil</h3>
            <form (ngSubmit)="guardarPerfil()" #perfilFormRef="ngForm">
              <div class="form-group">
                <label class="form-label">Nombre *</label>
                <input 
                  type="text" 
                  [(ngModel)]="perfilForm.nombre" 
                  name="nombre"
                  class="form-input"
                  [class.error]="formErrors['nombre']"
                  required
                >
                @if (formErrors['nombre']) {
                  <span class="error-message">{{ formErrors['nombre'] }}</span>
                }
              </div>

              @if (esArtesano()) {
                <div class="form-group">
                  <label class="form-label">Nombre del Emprendimiento *</label>
                  <input 
                    type="text" 
                    [(ngModel)]="perfilForm.nombreEmprendimiento" 
                    name="nombreEmprendimiento"
                    class="form-input"
                    [class.error]="formErrors['nombreEmprendimiento']"
                    required
                  >
                  @if (formErrors['nombreEmprendimiento']) {
                    <span class="error-message">{{ formErrors['nombreEmprendimiento'] }}</span>
                  }
                </div>

                <div class="form-group">
                  <label class="form-label">Descripción *</label>
                  <textarea 
                    [(ngModel)]="perfilForm.descripcion" 
                    name="descripcion"
                    class="form-textarea"
                    [class.error]="formErrors['descripcion']"
                    rows="3"
                    required
                  ></textarea>
                  @if (formErrors['descripcion']) {
                    <span class="error-message">{{ formErrors['descripcion'] }}</span>
                  }
                </div>

                <div class="form-group">
                  <label class="form-label">Ubicación *</label>
                  <input 
                    type="text" 
                    [(ngModel)]="perfilForm.ubicacion" 
                    name="ubicacion"
                    class="form-input"
                    [class.error]="formErrors['ubicacion']"
                    required
                  >
                  @if (formErrors['ubicacion']) {
                    <span class="error-message">{{ formErrors['ubicacion'] }}</span>
                  }
                </div>
              }

              <div class="form-group">
                <label class="form-label">Teléfono</label>
                <input 
                  type="tel" 
                  [(ngModel)]="perfilForm.telefono" 
                  name="telefono"
                  class="form-input"
                  [class.error]="formErrors['telefono']"
                  placeholder="Ej: 3511234567"
                >
                @if (formErrors['telefono']) {
                  <span class="error-message">{{ formErrors['telefono'] }}</span>
                }
              </div>

              <div class="form-actions">
                <button type="button" (click)="cancelarEdicionPerfil()" class="cancel-button">
                  Cancelar
                </button>
                <button type="submit" class="save-button" [disabled]="isLoading">
                  @if (isLoading) {
                    <div class="loading-spinner-small"></div>
                  }
                  Guardar Cambios
                </button>
              </div>
            </form>
          </div>
        }

        <!-- Formulario de cambio de contraseña -->
        @if (editandoPassword) {
          <div class="form-card">
            <h3 class="form-title">Cambiar Contraseña</h3>
            <form (ngSubmit)="cambiarPassword()" #passwordFormRef="ngForm">
              <div class="form-group">
                <label class="form-label">Contraseña Actual *</label>
                <input 
                  type="password" 
                  [(ngModel)]="passwordForm.passwordActual" 
                  name="passwordActual"
                  class="form-input"
                  [class.error]="formErrors['passwordActual']"
                  required
                >
                @if (formErrors['passwordActual']) {
                  <span class="error-message">{{ formErrors['passwordActual'] }}</span>
                }
              </div>

              <div class="form-group">
                <label class="form-label">Nueva Contraseña *</label>
                <input 
                  type="password" 
                  [(ngModel)]="passwordForm.passwordNuevo" 
                  name="passwordNuevo"
                  class="form-input"
                  [class.error]="formErrors['passwordNuevo']"
                  required
                >
                @if (formErrors['passwordNuevo']) {
                  <span class="error-message">{{ formErrors['passwordNuevo'] }}</span>
                }
              </div>

              <div class="form-actions">
                <button type="button" (click)="cancelarEdicionPassword()" class="cancel-button">
                  Cancelar
                </button>
                <button type="submit" class="save-button" [disabled]="isLoading">
                  @if (isLoading) {
                    <div class="loading-spinner-small"></div>
                  }
                  Cambiar Contraseña
                </button>
              </div>
            </form>
          </div>
        }

        <!-- Formulario de conversión a artesano -->
        @if (convirtiendoArtesano) {
          <div class="form-card">
            <h3 class="form-title">Convertirse en Artesano</h3>
            <p class="form-description">
              Completa la información de tu emprendimiento para comenzar a vender tus productos.
            </p>
            <form (ngSubmit)="convertirArtesano()" #artesanoFormRef="ngForm">
              <div class="form-group">
                <label class="form-label">Nombre del Emprendimiento *</label>
                <input 
                  type="text" 
                  [(ngModel)]="artesanoForm.nombreEmprendimiento" 
                  name="nombreEmprendimiento"
                  class="form-input"
                  [class.error]="formErrors['nombreEmprendimiento']"
                  placeholder="Ej: Taller de Cerámica María"
                  required
                >
                @if (formErrors['nombreEmprendimiento']) {
                  <span class="error-message">{{ formErrors['nombreEmprendimiento'] }}</span>
                }
              </div>

              <div class="form-group">
                <label class="form-label">Descripción *</label>
                <textarea 
                  [(ngModel)]="artesanoForm.descripcion" 
                  name="descripcion"
                  class="form-textarea"
                  [class.error]="formErrors['descripcion']"
                  rows="3"
                  placeholder="Cuéntanos sobre tu emprendimiento, técnicas que usas, etc."
                  required
                ></textarea>
                @if (formErrors['descripcion']) {
                  <span class="error-message">{{ formErrors['descripcion'] }}</span>
                }
              </div>

              <div class="form-group">
                <label class="form-label">Ubicación *</label>
                <input 
                  type="text" 
                  [(ngModel)]="artesanoForm.ubicacion" 
                  name="ubicacion"
                  class="form-input"
                  [class.error]="formErrors['ubicacion']"
                  placeholder="Ej: Buenos Aires, Argentina"
                  required
                >
                @if (formErrors['ubicacion']) {
                  <span class="error-message">{{ formErrors['ubicacion'] }}</span>
                }
              </div>

              <div class="form-actions">
                <button type="button" (click)="cancelarConversionArtesano()" class="cancel-button">
                  Cancelar
                </button>
                <button type="submit" class="convert-button" [disabled]="isLoading">
                  @if (isLoading) {
                    <div class="loading-spinner-small"></div>
                  }
                  Convertirse en Artesano
                </button>
              </div>
            </form>
          </div>
        }

        <!-- Botón para cambiar contraseña -->
        @if (!editandoPassword && !convirtiendoArtesano) {
          <div class="password-section">
            <button (click)="iniciarEdicionPassword()" class="password-button">
              <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 7a2 2 0 012 2m4 0a6 6 0 01-7.743 5.743L11 17H9v2H7v2H4a1 1 0 01-1-1v-2.586a1 1 0 01.293-.707l5.964-5.964A6 6 0 1121 9z"></path>
              </svg>
              Cambiar Contraseña
            </button>
          </div>
        }
      </div>
    }
  </div>
</div>